<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel da Barbearia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
    <h2 class="mb-4">üíà Agenda do Dia</h2>

    <div class="card shadow-sm">
        <div class="card-body">
            <table class="table table-hover align-middle">
                <thead class="table-dark">
                <tr>
                    <th>Cliente</th>
                    <th>Telefone</th>
                    <th>Servi√ßo</th>
                    <th>Data e Hora</th>
                    <th>Status</th>
                    <th>A√ß√µes</th> </tr>
                </thead>
                <tbody id="tabela-agendamentos">
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    async function carregarAgendamentos() {
        try {
            const resposta = await fetch('/api/agendamentos');
            const agendamentos = await resposta.json();

            const corpoTabela = document.getElementById('tabela-agendamentos');
            corpoTabela.innerHTML = '';

            agendamentos.forEach(agendamento => {
                const dataFormatada = new Date(agendamento.dataHoraInicio).toLocaleString('pt-BR');

                // L√≥gica visual: Se estiver cancelado, fica vermelho. Sen√£o, fica verde.
                const corBadge = agendamento.status === 'CANCELADO' ? 'bg-danger' : 'bg-success';

                // Se estiver cancelado, n√£o mostra o bot√£o de cancelar novamente
                const botaoAcao = agendamento.status === 'CANCELADO'
                    ? '<span class="text-muted">J√° cancelado</span>'
                    : `<button class="btn btn-sm btn-outline-danger" onclick="cancelar(${agendamento.id})">‚ùå Cancelar</button>`;

                const linha = `
                        <tr>
                            <td><strong>${agendamento.nomeCliente}</strong></td>
                            <td>${agendamento.telefoneCliente}</td>
                            <td>${agendamento.servicoEscolhido.nome}</td>
                            <td>${dataFormatada}</td>
                            <td><span class="badge ${corBadge}">${agendamento.status}</span></td>
                            <td>${botaoAcao}</td>
                        </tr>
                    `;
                corpoTabela.innerHTML += linha;
            });
        } catch (erro) {
            console.error("Erro ao buscar dados da API:", erro);
        }
    }

    // --- NOVA FUN√á√ÉO QUE O BOT√ÉO VAI CHAMAR ---
    async function cancelar(id) {
        // Pede uma confirma√ß√£o para o dono n√£o clicar sem querer
        if(confirm("Tem certeza que deseja cancelar este agendamento? O hor√°rio voltar√° a ficar livre.")) {
            try {
                // Chama a URL de Put que criamos no Java
                await fetch(`/api/agendamentos/${id}/cancelar`, { method: 'PUT' });

                // Recarrega a tabela para a tela atualizar na mesma hora!
                carregarAgendamentos();
            } catch (erro) {
                alert("Erro ao tentar cancelar!");
            }
        }
    }

    carregarAgendamentos();
</script>
</body>
</html>