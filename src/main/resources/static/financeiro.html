<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financeiro - Barbearia</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* Cor personalizada: Vermelho suave/fosco para n√£o agredir os olhos nas taxas */
    .text-suave-danger {
      color: #c94c4c !important;
    }
    .border-suave-danger {
      border-color: #c94c4c !important;
    }

    @media (max-width: 767.98px) {
      .tabela-mobile thead { display: none; }
      .tabela-mobile tbody tr {
        display: block;
        margin-bottom: 1rem;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
      }
      .tabela-mobile tbody td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-align: right;
        border-bottom: 1px solid #dee2e6;
        padding: 0.75rem 1rem;
      }
      .tabela-mobile tbody td:last-child { border-bottom: none; }
      .tabela-mobile tbody td::before {
        content: attr(data-label);
        font-weight: bold;
        color: #6c757d;
        text-transform: uppercase;
        font-size: 0.75rem;
        margin-right: 1rem;
        text-align: left;
      }
    }
  </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#">üíà Barbearia Bot</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menuNavegacao">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="menuNavegacao">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0 mt-2 mt-lg-0">
        <li class="nav-item">
          <a class="nav-link" href="index.html">üìÖ Agenda do Dia</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="financeiro.html">üí∞ Financeiro</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="servicos.html">‚úÇÔ∏è Servi√ßos</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container">

  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
    <h2 class="mb-0">Vis√£o Financeira</h2>
    <div class="d-flex align-items-center bg-white p-2 rounded shadow-sm border w-100 w-md-auto">
      <label for="filtro-mes" class="me-2 fw-bold text-secondary mb-0 text-nowrap">M√™s:</label>
      <input type="month" id="filtro-mes" class="form-control border-0 p-0 fw-bold text-primary flex-grow-1" onchange="carregarFinanceiro()">
    </div>
  </div>

  <div class="row mb-4 g-3">

    <div class="col-12 col-md-4">
      <div class="card shadow-sm border-0 border-success border-start border-5 h-100">
        <div class="card-body">
          <h6 class="text-muted text-uppercase mb-1" style="font-size: 0.85rem;">Lucro L√≠quido Mensal</h6>
          <h2 class="text-success fw-bold mb-0" id="valor-faturamento">R$ 0,00</h2>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="card shadow-sm border-0 border-suave-danger border-start border-5 h-100">
        <div class="card-body">
          <h6 class="text-muted text-uppercase mb-1" style="font-size: 0.85rem;">Taxas Pagas (Maquininha)</h6>
          <h2 class="text-suave-danger fw-bold mb-0" id="valor-taxas">R$ 0,00</h2>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="card shadow-sm border-0 border-primary border-start border-5 h-100">
        <div class="card-body">
          <h6 class="text-muted text-uppercase mb-1" style="font-size: 0.85rem;">Servi√ßos Conclu√≠dos</h6>
          <h2 class="text-primary fw-bold mb-0" id="qtd-servicos">0</h2>
        </div>
      </div>
    </div>

  </div>

  <div class="card shadow-sm border-0 mb-5 bg-transparent bg-md-white">
    <div class="card-header bg-white py-3 d-none d-md-block rounded-top">
      <h5 class="mb-0 fw-bold">Extrato Detalhado</h5>
    </div>
    <div class="card-body p-0 p-md-3">
      <table class="table table-hover align-middle text-center tabela-mobile mb-0">
        <thead class="table-light">
        <tr>
          <th>Data e Hora</th>
          <th>Cliente</th>
          <th>Servi√ßo</th>
          <th>Pagamento</th>
          <th>Lucro L√≠quido</th>
          <th>A√ß√µes</th>
        </tr>
        </thead>
        <tbody id="tabela-extrato">
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const dataHoje = new Date();
    const ano = dataHoje.getFullYear();
    const mes = String(dataHoje.getMonth() + 1).padStart(2, '0');
    document.getElementById('filtro-mes').value = `${ano}-${mes}`;
    carregarFinanceiro();
  });

  async function carregarFinanceiro() {
    try {
      const resposta = await fetch('/api/agendamentos');
      const todosAgendamentos = await resposta.json();
      const mesEscolhido = document.getElementById('filtro-mes').value;

      let concluidos = todosAgendamentos.filter(ag => {
        return ag.status === 'CONCLUIDO' && ag.dataHoraInicio.startsWith(mesEscolhido);
      });

      concluidos.sort((a, b) => new Date(b.dataHoraInicio) - new Date(a.dataHoraInicio));

      let faturamentoTotal = 0;
      let taxasTotal = 0; // ‚ú® Vari√°vel nova para somar o dinheiro perdido

      const corpoTabela = document.getElementById('tabela-extrato');
      corpoTabela.innerHTML = '';

      if (concluidos.length === 0) {
        corpoTabela.innerHTML = '<tr><td colspan="6" class="text-muted py-4 text-center">Nenhum servi√ßo conclu√≠do neste m√™s.</td></tr>';
        document.getElementById('qtd-servicos').innerText = '0';
        document.getElementById('valor-faturamento').innerText = 'R$ 0,00';
        document.getElementById('valor-taxas').innerText = 'R$ 0,00';
        return;
      }

      concluidos.forEach(agendamento => {
        // ‚ú® A GRANDE CORRE√á√ÉO M√ÅGICA DO ARQUITETO: Puxa o Lucro L√≠quido Historical real R$ 33,31 ou R$ 35,00
        let lucroReal = Number(agendamento.faturamentoBarbeiro);

        let precoTabelaHistorico = 0;
        // Puxa o Snapshot do pre√ßo base pago no momento do corte (se for novo e tiver)
        if (agendamento.valorTotalHistorico != null && agendamento.valorTotalHistorico > 0) {
          precoTabelaHistorico = Number(agendamento.valorTotalHistorico);
        } else if (agendamento.valorFinal != null) {
          // Suporte para registros muito antigos (da migra√ß√£o) que tinham valorFinal
          precoTabelaHistorico = Number(agendamento.valorFinal);
        } else {
          // Suporte preventivo para registros hist√≥ricos que tinham o pre√ßo fixo antigo (R$ 35,00 implied PIX)
          // Jamais olharemos pro pre√ßo ativo do servi√ßo para o c√°lculo das taxas hist√≥ricas.
          // Para Yarha PIX R$ 35,00, a taxa hist√≥rica foi zero.
          // Para Rafael CC R$ 33,31, a taxa hist√≥rica foi R$ 1,69.
          precoTabelaHistorico = lucroReal;
        }

        // ‚ú® A M√ÅGICA DO VAZAMENTO DE CAIXA: Snapshot Total Base menos o Snapshot Lucro L√≠quido Real R$ 33,31 ou R$ 35,00
        // O Math.max(0, ...) evita n√∫meros negativos caso o barbeiro editasse o lucro para um valor MAIOR que o pre√ßo de tabela
        let taxaPerdida = Math.max(0, precoTabelaHistorico - lucroReal);

        faturamentoTotal += lucroReal;
        taxasTotal += taxaPerdida;

        const dataFormatada = new Date(agendamento.dataHoraInicio).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
        const lucroFormatado = lucroReal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formaPgto = agendamento.formaPagamento || 'N√£o informada';

        let corPagamento = 'text-dark';
        if (formaPgto.includes('Cr√©dito')) corPagamento = 'text-primary';
        if (formaPgto.includes('D√©bito')) corPagamento = 'text-info';
        if (formaPgto.includes('PIX') || formaPgto.includes('Dinheiro')) corPagamento = 'text-success';

        const linha = `
                    <tr>
                        <td data-label="Data/Hora" class="text-muted">${dataFormatada}</td>
                        <td data-label="Cliente"><strong>${agendamento.nomeCliente}</strong></td>
                        <td data-label="Servi√ßo">${agendamento.servicoEscolhido.nome} <br><small class="text-muted">R$ ${precoTabelaHistorico.toFixed(2)}</small></td>
                        <td data-label="Pagamento" class="fw-bold ${corPagamento}">${formaPgto}</td>
                        <td data-label="Lucro" class="text-success fw-bold">${lucroFormatado}</td>
                        <td data-label="A√ß√µes">
                            <button class="btn btn-sm btn-outline-secondary w-100 w-md-auto" onclick="editarValor(${agendamento.id}, ${lucroReal})">‚úèÔ∏è Editar</button>
                        </td>
                    </tr>
                `;
        corpoTabela.innerHTML += linha;
      });

      // Atualiza os pain√©is gerenciais no topo
      document.getElementById('qtd-servicos').innerText = concluidos.length;
      document.getElementById('valor-faturamento').innerText = faturamentoTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      document.getElementById('valor-taxas').innerText = taxasTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); // Atualiza o card vermelho fosco #c94c4c

    } catch (erro) {
      console.error("Erro ao buscar dados financeiros:", erro);
    }
  }

  async function editarValor(id, valorAtual) {
    const novoValorStr = prompt("Digite o novo valor de LUCRO L√çQUIDO cobrado (use ponto em vez de v√≠rgula, ex: 55.50):", valorAtual.toFixed(2));

    if (novoValorStr !== null && novoValorStr.trim() !== "") {
      const novoValor = parseFloat(novoValorStr.replace(',', '.'));

      if (!isNaN(novoValor)) {
        try {
          // Suporte para registros financeiros hist√≥ricos (extrato detalhado)
          await fetch(`/api/agendamentos/${id}/valor?novoValor=${novoValor}`, { method: 'PUT' });
          carregarFinanceiro();
        } catch (erro) {
          alert("Erro ao tentar alterar o valor!");
        }
      } else {
        alert("Por favor, digite um n√∫mero v√°lido.");
      }
    }
  }
</script>
</body>
</html>